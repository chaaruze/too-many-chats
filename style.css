/**
 * Too Many Chats - Styles v2.1.1 (Maintenance Hotfix)
 * ChatGPT-inspired clean layout with SillyTavern theme integration
 */

/* 
   Native Chat List Hiding Strategy:
   We cannot use display:none or height:0 because SillyTavern's virtual scroller
   needs the container to have dimensions to render items.
   
   Solution:
   1. Give it full viewport size so virtualization renders ALL items (or enough of them).
   2. Position it absolutely FAR off-screen so it doesn't affect layout.
   3. Opacity 0 and pointer-events none to be safe.
*/
#select_chat_popup .select_chat_block_wrapper,
#shadow_select_chat_popup .select_chat_block_wrapper,
#select_chat_div {
    position: absolute !important;
    top: -9999px !important;
    /* Move far off-screen */
    left: 0 !important;
    width: 100vw !important;
    /* Full width */
    height: 100vh !important;
    /* Full height to trigger rendering */
    min-height: 100vh !important;
    overflow: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
    z-index: -100 !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
}

/* ========== POPUP OVERRIDES ========== */
/* Note: We do NOT override display here - SillyTavern controls when the popup is visible.
   The extension only styles the popup when it's already visible. */
#select_chat_popup:not([style*="display: none"]):not([style*="display:none"]),
#shadow_select_chat_popup:not([style*="display: none"]):not([style*="display:none"]) {
    /* Only apply layout fixes when popup is visible - do NOT force display */
    flex-direction: column !important;
    overflow: hidden !important;
    position: relative !important;
    /* Context for absolute children */

    /* Remove any shadow/mask that causes the "halved" blue blur */
    box-shadow: none !important;
    mask-image: none !important;
    -webkit-mask-image: none !important;
    backdrop-filter: blur(10px) !important;
}

/* Header layout fix: Search bar + Close button on same row */
#select_chat_popup #select_chat_search {
    /* Reduce width to leave room for the X button + gap (10px) */
    width: calc(100% - 50px) !important;
    flex: 0 0 auto !important;
    margin-right: 0 !important;
}

#select_chat_popup #select_chat_cross {
    /* Ensure it fits nicely next to search */
    width: 35px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    margin: 0 !important;
}

#select_chat_popup_body {
    display: flex !important;
    flex-direction: column !important;
    padding: 0 !important;
    overflow: hidden !important;
    flex: 1 1 auto !important;
    height: 100% !important;
    position: relative !important;
}

/* ========== NEW FOLDER BUTTON (Header) ========== */
/* ========== NEW FOLDER BUTTON (Header) ========== */
/* Updated to work with .menu_button class */
.tmc_add_btn {
    display: flex !important;
    align-items: center !important;
    gap: 5px !important;
    padding: 5px 10px !important;
    margin: 0 5px !important;
    /* Let menu_button handle background/border or default to transparent */
    /* background: var(--SmartThemeBlurTintColor) !important; */
    /* border: 1px solid var(--SmartThemeBorderColor) !important; */
    border-radius: 5px !important;
    /* 
    color: var(--SmartThemeBodyColor) !important;
    */
    font-size: 13px !important;
    cursor: pointer !important;
    white-space: nowrap !important;
}

.tmc_add_btn:hover {
    /* Keep hover highlight */
    background: var(--SmartThemeQuoteColor) !important;
    border-color: var(--SmartThemeQuoteColor) !important;
    color: var(--SmartThemeBodyText) !important;
}

.tmc_add_btn i {
    font-size: 12px !important;
}

/* Proxy Root - Scrollable container */
#tmc_proxy_root {
    flex: 1 1 auto !important;
    height: auto !important;
    min-height: 0 !important;
    /* Critical for flex scrolling */
    overflow-y: auto !important;
    width: 100% !important;
    display: block !important;
    max-height: calc(100vh - 200px) !important;
    padding: 4px 0;
}

/* ========== FOLDER SECTION ========== */
.tmc_section {
    background: transparent;
    border: none;
    border-radius: 0;
    margin-bottom: 2px;
    flex-shrink: 0;
    width: 100%;
    /* Ensure full width */
    min-width: 100%;
}

.tmc_header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 8px;
    background: transparent;
    cursor: pointer;
    user-select: none;
    font-size: 13px;
    color: var(--SmartThemeBodyColor);
    border-radius: 6px;
    transition: background 0.1s;
}

.tmc_header:hover {
    background: var(--SmartThemeBlurTintColor);
}

.tmc_header_left {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    min-width: 0;
}

.tmc_header_right {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.15s;
}

.tmc_header:hover .tmc_header_right {
    opacity: 1;
}

.tmc_toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    color: var(--SmartThemeBodyColor);
    opacity: 0.5;
    transition: transform 0.15s;
}

.tmc_toggle i {
    font-size: 10px;
}

.tmc_section[data-collapsed="true"] .tmc_toggle {
    transform: rotate(-90deg);
}

.tmc_icon {
    display: flex;
    align-items: center;
    font-size: 14px;
    opacity: 0.8;
    color: var(--SmartThemeBodyColor);
}

.tmc_name {
    font-weight: 500;
    color: var(--SmartThemeBodyColor);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.tmc_count {
    font-size: 11px;
    color: var(--SmartThemeBodyColor);
    opacity: 0.5;
    margin-left: 4px;
}

/* Action buttons */
.tmc_btn {
    padding: 4px;
    font-size: 11px;
    border-radius: 4px;
    cursor: pointer;
    color: var(--SmartThemeBodyColor);
    opacity: 0.6;
}

.tmc_btn:hover {
    opacity: 1;
    background: var(--SmartThemeBorderColor);
}

.tmc_del:hover {
    color: #ff6b6b;
}

/* ========== CHAT CONTENT ========== */
.tmc_content {
    display: flex;
    flex-direction: column;
    padding-left: 20px;
}

/* Chat Item */
.tmc_proxy_block.select_chat_block {
    display: flex !important;
    flex-direction: column !important;
    align-items: stretch !important;
    padding: 8px 10px !important;
    margin: 0 0 6px 0 !important;
    border: 1px solid var(--SmartThemeBorderColor) !important;
    border-radius: 6px !important;
    background: transparent !important;
    cursor: pointer !important;
    transition: background 0.1s, border-color 0.1s !important;
    width: 100% !important;
    min-width: 100% !important;
    /* Fix halved display */
    flex: 0 0 100% !important;
    /* Fix flex shrinking/sharing */
    box-sizing: border-box !important;
    white-space: normal !important;
    position: relative !important;
}

.tmc_proxy_block.select_chat_block>div:first-child,
.tmc_proxy_block.select_chat_block .select_chat_block_header {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    width: 100% !important;
    gap: 8px !important;
}

/* Move pencil icon */
.tmc_proxy_block.select_chat_block .mes_edit,
.tmc_proxy_block.select_chat_block .select_chat_block_rename,
.tmc_proxy_block.select_chat_block [class*="rename"],
.tmc_proxy_block.select_chat_block [class*="edit"]:not(.select_chat_block) {
    order: 99 !important;
    margin-left: 4px !important;
}

.tmc_proxy_block.select_chat_block .select_chat_block_buttons,
.tmc_proxy_block.select_chat_block .select_chat_block_action {
    display: flex !important;
    align-items: center !important;
    gap: 4px !important;
    margin-left: auto !important;
    flex-shrink: 0 !important;
}

.tmc_proxy_block.select_chat_block:hover {
    background: var(--SmartThemeBlurTintColor) !important;
    border-color: var(--SmartThemeQuoteColor) !important;
}

.tmc_chat_title {
    flex: 1;
    font-size: 13px;
    color: var(--SmartThemeBodyColor);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
}

.tmc_chat_date {
    font-size: 11px;
    color: var(--SmartThemeBodyColor);
    opacity: 0.5;
    margin-left: 8px;
    white-space: nowrap;
}

/* Pinned Item */
.tmc_pinned {
    background: linear-gradient(90deg, var(--SmartThemeBlurTintColor), transparent);
    border-left: 2px solid var(--SmartThemeQuoteColor) !important;
}

/* ========== UNCATEGORIZED & RECENT ========== */
.tmc_uncat {
    margin-top: 8px;
    border-top: 1px solid var(--SmartThemeBorderColor);
    padding-top: 8px;
}

.tmc_uncat .tmc_header {
    opacity: 0.7;
}

.tmc_uncat .tmc_content {
    padding-left: 8px;
}

/* ========== CONTEXT MENU ========== */
.tmc_ctx {
    position: fixed;
    background: var(--SmartThemeBlurTintColor);
    border: 1px solid var(--SmartThemeBorderColor);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 20002;
    min-width: 160px;
    border-radius: 8px;
    overflow: hidden;
    backdrop-filter: blur(10px);
}

.tmc_ctx_head {
    padding: 6px 12px;
    font-size: 10px;
    color: var(--SmartThemeBodyColor);
    opacity: 0.6;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--SmartThemeBorderColor);
}

.tmc_ctx_item {
    padding: 8px 12px;
    color: var(--SmartThemeBodyColor);
    cursor: pointer;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tmc_ctx_item:hover {
    background: var(--SmartThemeUpperBarColor);
}

.tmc_ctx_sep {
    height: 1px;
    background: var(--SmartThemeBorderColor);
    margin: 4px 0;
}


/* ========== SCROLLBAR ========== */
#tmc_proxy_root::-webkit-scrollbar {
    width: 6px;
}

#tmc_proxy_root::-webkit-scrollbar-track {
    background: transparent;
}

#tmc_proxy_root::-webkit-scrollbar-thumb {
    background: var(--SmartThemeBorderColor);
    border-radius: 3px;
}

#tmc_proxy_root::-webkit-scrollbar-thumb:hover {
    background: var(--SmartThemeBodyColor);
    opacity: 0.5;
}

/* ========== BULK ACTIONS ========== */
#tmc_bulk_bar {
    position: fixed;
    top: auto !important;
    /* Prevent it from flying off screen */
    bottom: 20px !important;
    left: 50%;
    transform: translateX(-50%);
    background: var(--SmartThemeBlurTintColor);
    backdrop-filter: blur(10px);
    border: 1px solid var(--SmartThemeBorderColor);
    padding: 10px 20px;
    border-radius: 12px;
    display: flex !important;
    align-items: center;
    gap: 15px;
    z-index: 99999 !important;
    /* Very high to ensure visibility above popups */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    visibility: visible !important;
    opacity: 1 !important;
    max-width: 90vw;
    /* Prevent overflow on small screens */
    flex-wrap: wrap;
    /* Allow wrapping if needed */
    justify-content: center;
}

/* Mobile Fix for Bulk Bar */
/* Mobile Fix for Bulk Bar */
@media screen and (max-width: 480px) {
    #tmc_bulk_bar {
        position: fixed !important;
        inset: auto 0 0 0 !important;
        width: 100% !important;
        max-width: 100% !important;
        transform: none !important;
        border-radius: 0 !important;
        gap: 10px !important;
        padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px)) !important;
        z-index: 2147483647 !important;
        /* Max z-index */
        top: auto !important;
        bottom: 0 !important;
    }
}

.tmc_bulk_info {
    font-weight: bold;
    color: var(--SmartThemeBodyText);
}

.tmc_bulk_actions {
    display: flex;
    gap: 10px;
}

#tmc_bulk_bar button {
    padding: 6px 14px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    background: var(--SmartThemeQuoteColor);
    color: var(--SmartThemeBodyText);
    font-weight: bold;
}

#tmc_bulk_bar button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

#tmc_bulk_cancel {
    background: transparent;
    border: 1px solid var(--SmartThemeBorderColor) !important;
}

.tmc_bulk_check {
    margin-right: 8px;
    font-size: 1.1em;
    color: var(--SmartThemeQuoteColor);
}

.tmc_selected {
    background: var(--SmartThemeQuoteColor);
    border-color: var(--SmartThemeQuoteColor) !important;
}

.tmc_selected * {
    color: #fff !important;
    /* Force readable text on selected */
}

.tmc_bulk_btn {
    /* Inherits from tmc_add_btn but maybe specific color? */
}

/* ========== HEADER & SEARCH FIXES ========== */
[name="selectChatPopupHeader"] {
    flex-wrap: wrap !important;
    gap: 4px !important;
    height: auto !important;
    padding-bottom: 4px !important;
    min-height: auto !important;
    position: relative !important;
    z-index: 10 !important;
}

#select_chat_popup input[type="text"],
#select_chat_popup input[type="search"] {
    min-width: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
    flex: 1 1 auto !important;
    margin: 4px 0 !important;
}

.tmc_add_btn,
#newChatFromManageScreenButton,
#importChatButton {
    flex-shrink: 0 !important;
}

/* ========== MOBILE RESPONSIVE ========== */
@media screen and (max-width: 768px) {

    #select_chat_popup[style]:not([style*="display: none"]) {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100dvh !important;
        max-width: 100vw !important;
        max-height: 100dvh !important;
        min-width: 100vw !important;
        min-height: 100dvh !important;
        inset: 0 !important;
        margin: 0 !important;
        padding: 10px !important;
        border-radius: 0 !important;
        transform: none !important;
        z-index: 9999 !important;

        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
        overflow: hidden !important;
        /* Ensure the popup takes full height */
        height: 100% !important;
        max-height: 100vh !important;

        /* Remove any shadow/mask that causes the "halved" blue blur */
        box-shadow: none !important;
        mask-image: none !important;
        -webkit-mask-image: none !important;
        backdrop-filter: blur(10px) !important;
        /* Keep blur, lose the gradient/shadow */
    }

    #select_chat_popup_body {
        flex: 1 1 auto !important;
        height: auto !important;
        overflow: hidden !important;
    }

    #shadow_select_chat_popup[style]:not([style*="display: none"]) {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100dvh !important;
        display: block !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    /* Ensure the proxy root grows to fill the space and scrolls internally */
    #tmc_proxy_root {
        flex: 1 1 auto !important;
        height: auto !important;
        min-height: 0 !important;
        /* Critical for flex scrolling */
        overflow-y: auto !important;
        width: 100% !important;
        display: block !important;
        padding: 8px !important;
    }

    .tmc_header {
        padding: 10px 12px !important;
        font-size: 14px !important;
    }

    .tmc_header_right {
        opacity: 1 !important;
    }

    .tmc_content {
        padding-left: 12px !important;
    }

    .tmc_proxy_block.select_chat_block {
        padding: 10px 12px !important;
        margin: 0 0 8px 0 !important;
    }

    .tmc_proxy_block.select_chat_block .select_chat_block_buttons,
    .tmc_proxy_block.select_chat_block .select_chat_block_action {
        flex-wrap: wrap !important;
        gap: 6px !important;
    }

    .tmc_btn {
        padding: 6px !important;
        font-size: 14px !important;
    }

    .tmc_icon i,
    .tmc_toggle i {
        font-size: 14px !important;
    }

    .tmc_ctx {
        min-width: 200px !important;
        max-width: 280px !important;
    }

    .tmc_ctx_item {
        padding: 12px 16px !important;
        font-size: 14px !important;
    }
}

/* Extra small screens (phones in portrait) */
@media screen and (max-width: 480px) {

    /* Folder Sections */
    .tmc_section {
        margin-bottom: 0 !important;
        border-bottom: 1px solid var(--SmartThemeBorderColor) !important;
    }

    .tmc_header {
        padding: 12px 10px !important;
        /* Comfortable touch target */
        margin: 0 !important;
        /* DO NOT set background: transparent - it kills folder colors */
        /* Folder colors are applied via inline style, preserve them */
    }

    .tmc_content {
        padding-left: 0 !important;
    }

    /* Stack date info below filename on very small screens */
    .tmc_proxy_block.select_chat_block .select_chat_info {
        font-size: 11px !important;
    }

    /* Force full width on EVERYTHING in the list */
    #tmc_proxy_root * {
        box-sizing: border-box !important;
    }

    /* Chat items: preserve borders even on mobile */
    .tmc_proxy_block.select_chat_block {
        width: calc(100vw - 20px) !important;
        max-width: calc(100vw - 20px) !important;
        margin: 0 0 8px 0 !important;
        border: 1px solid var(--SmartThemeBorderColor) !important;
        border-radius: 6px !important;
        flex: 0 0 auto !important;
    }

    /* Sections can be full width */
    .tmc_section {
        width: 100% !important;
        max-width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }
}

/* Folder Drill-Down Styles */
.tmc_show_more {
    padding: 10px;
    text-align: center;
    cursor: pointer;
    color: var(--SmartThemeBodyColor);
    opacity: 0.7;
    border-top: 1px solid var(--SmartThemeBorderColor);
    transition: all 0.2s;
    font-size: 0.9em;
}

.tmc_show_more:hover {
    opacity: 1;
    background: var(--SmartThemeBlurTintColor);
}

.tmc_back_btn {
    cursor: pointer;
    padding: 5px 8px;
    margin-right: 5px;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.tmc_back_btn:hover {
    opacity: 1;
}

.tmc_header.tmc_folder_view_header {
    background: transparent;
    border-bottom: 2px solid var(--SmartThemeBorderColor);
    margin-bottom: 10px;
}